FROM ghcr.io/railwayapp/nixpacks:ubuntu-1745885067

ENTRYPOINT ["/bin/bash", "-l", "-c"]
WORKDIR /app/


COPY .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix
RUN nix-env -if .nixpacks/nixpkgs-ffeebf0acf3ae8b29f8c7049cd911b9636efd7e7.nix && nix-collect-garbage -d
RUN sudo apt-get update && sudo apt-get install -y --no-install-recommends curl wget

ARG ADMIN_CORS AUTH_CORS CI COOKIE_SECRET COOLIFY_BRANCH COOLIFY_CONTAINER_NAME COOLIFY_FQDN COOLIFY_RESOURCE_UUID COOLIFY_URL DATABASE_URL DB_NAME JWT_SECRET MEDUSA_ADMIN_ONBOARDING_NEXTJS_DIRECTORY MEDUSA_ADMIN_ONBOARDING_TYPE MEDUSA_BACKEND_URL MEDUSA_FF_PRODUCT_CATEGORIES NEXT_PUBLIC_DEFAULT_REGION NIXPACKS_METADATA NIXPACKS_NODE_VERSION NODE_ENV NODE_OPTIONS NPM_CONFIG_PRODUCTION REDIS_URL S3_ACCESS_KEY_ID S3_BUCKET S3_ENDPOINT S3_FILE_URL S3_REGION S3_SECRET_ACCESS_KEY SOURCE_COMMIT STORE_CORS STRAPI_ADMIN_URL VITE_STRAPI_ADMIN_URL
ENV ADMIN_CORS=$ADMIN_CORS AUTH_CORS=$AUTH_CORS CI=$CI COOKIE_SECRET=$COOKIE_SECRET COOLIFY_BRANCH=$COOLIFY_BRANCH COOLIFY_CONTAINER_NAME=$COOLIFY_CONTAINER_NAME COOLIFY_FQDN=$COOLIFY_FQDN COOLIFY_RESOURCE_UUID=$COOLIFY_RESOURCE_UUID COOLIFY_URL=$COOLIFY_URL DATABASE_URL=$DATABASE_URL DB_NAME=$DB_NAME JWT_SECRET=$JWT_SECRET MEDUSA_ADMIN_ONBOARDING_NEXTJS_DIRECTORY=$MEDUSA_ADMIN_ONBOARDING_NEXTJS_DIRECTORY MEDUSA_ADMIN_ONBOARDING_TYPE=$MEDUSA_ADMIN_ONBOARDING_TYPE MEDUSA_BACKEND_URL=$MEDUSA_BACKEND_URL MEDUSA_FF_PRODUCT_CATEGORIES=$MEDUSA_FF_PRODUCT_CATEGORIES NEXT_PUBLIC_DEFAULT_REGION=$NEXT_PUBLIC_DEFAULT_REGION NIXPACKS_METADATA=$NIXPACKS_METADATA NIXPACKS_NODE_VERSION=$NIXPACKS_NODE_VERSION NODE_ENV=$NODE_ENV NODE_OPTIONS=$NODE_OPTIONS NPM_CONFIG_PRODUCTION=$NPM_CONFIG_PRODUCTION REDIS_URL=$REDIS_URL S3_ACCESS_KEY_ID=$S3_ACCESS_KEY_ID S3_BUCKET=$S3_BUCKET S3_ENDPOINT=$S3_ENDPOINT S3_FILE_URL=$S3_FILE_URL S3_REGION=$S3_REGION S3_SECRET_ACCESS_KEY=$S3_SECRET_ACCESS_KEY SOURCE_COMMIT=$SOURCE_COMMIT STORE_CORS=$STORE_CORS STRAPI_ADMIN_URL=$STRAPI_ADMIN_URL VITE_STRAPI_ADMIN_URL=$VITE_STRAPI_ADMIN_URL

# setup phase
# noop

# install phase
ENV NIXPACKS_PATH=/app/node_modules/.bin:$NIXPACKS_PATH
COPY . /app/.
RUN --mount=type=cache,id=acw8cogkgwgkoow8sgcso488-/root/npm,target=/root/.npm npm install

# build phase
COPY . /app/.
RUN --mount=type=cache,id=acw8cogkgwgkoow8sgcso488-node_modules/cache,target=/app/node_modules/.cache npm run build


RUN printf '\nPATH=/app/node_modules/.bin:$PATH' >> /root/.profile


# start
COPY . /app

CMD ["npm run start"]

